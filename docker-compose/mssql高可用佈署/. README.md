
# 📘 SQL Server 2022 Always On 高可用部署說明文件

> 適用環境：Ubuntu 24.04 + Docker + SQL Server Developer 版（容器）

---

## ✅ 伺服器架構

- 節點：
  - Primary：`mssql-primary`（192.168.25.101）
  - Secondary1：`mssql-secondary1`（192.168.25.102）
  - Secondary2：`mssql-secondary2`（192.168.25.103）
- Listener 虛擬 IP：`192.168.25.250`
- 子網：`192.168.25.0/24`
- 用戶端連線：`AGListener:1433`

---

## 🚀 部署流程

---

### 🧱 第 1 步：部署容器環境

#### ✅ 建立共享目錄（主機執行）

```bash
sudo mkdir -p /mnt/hadr_certs
sudo chown -R 10001:0 /mnt/hadr_certs
```

#### ✅ 啟動 SQL Server 容器

```bash
docker compose up -d
```

---

### 🔐 第 2 步：建立憑證與 HADR Endpoint

#### ✅ 在 Primary 容器中執行

```bash
docker exec -it mssql-primary bash
./setup-hadr.sh PRIMARY
```

此步驟將產生憑證 `/var/opt/mssql/hadr_cert/hadr_primary_cert.cer`

#### ✅ 手動將憑證複製到其他容器

```bash
docker cp mssql-primary:/var/opt/mssql/hadr_cert/hadr_primary_cert.cer .
docker cp hadr_primary_cert.cer mssql-secondary1:/var/opt/mssql/hadr_cert/
docker cp hadr_primary_cert.cer mssql-secondary2:/var/opt/mssql/hadr_cert/
```

#### ✅ 在每個 Secondary 容器中執行

```bash
docker exec -it mssql-secondary1 bash
./setup-hadr.sh SECONDARY

docker exec -it mssql-secondary2 bash
./setup-hadr.sh SECONDARY
```

---

### 📡 第 3 步：建立 Availability Group 與 Listener

#### ✅ 登入 Primary 並執行 AG 設定腳本

```bash
docker exec -it mssql-primary /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'Sql@admin123' -i /var/opt/mssql/scripts/init_ag.sql
```

> 此腳本會：
> - 建立 AG（AG_DevGroup）
> - 設定 3 節點複本（含同步與非同步）
> - 建立 Listener（192.168.25.250）
> - 加入資料庫 `TestDB`（請先建立空 DB）

---

### 🧪 第 4 步：測試連線

#### ✅ 手動在 /etc/hosts 設定 DNS（若無內部 DNS）

```bash
sudo echo "192.168.25.250 AGListener" >> /etc/hosts
```

#### ✅ 測試連線

```bash
sqlcmd -S AGListener,1433 -U SA -P 'Sql@admin123'
```

或應用程式連線字串：

```plaintext
Server=AGListener;Database=TestDB;User Id=SA;Password=Sql@admin123;
```

---

## 🧼 清除容器

```bash
docker compose down -v
```

---

### 📦 檔案總覽

| 檔案名稱              | 說明                            |
|-----------------------|----------------------------------|
| `docker-compose.yml` | 建立三節點 SQL Server 容器環境 |
| `setup-hadr.sh`       | 建立憑證與 HADR Endpoint         |
| `init_ag.sql`         | 建立 Availability Group 與 Listener |

---

