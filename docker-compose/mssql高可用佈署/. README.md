
# ğŸ“˜ SQL Server 2022 Always On é«˜å¯ç”¨éƒ¨ç½²èªªæ˜æ–‡ä»¶

> é©ç”¨ç’°å¢ƒï¼šUbuntu 24.04 + Docker + SQL Server Developer ç‰ˆï¼ˆå®¹å™¨ï¼‰

---

## âœ… ä¼ºæœå™¨æ¶æ§‹

- ç¯€é»ï¼š
  - Primaryï¼š`mssql-primary`ï¼ˆ192.168.25.101ï¼‰
  - Secondary1ï¼š`mssql-secondary1`ï¼ˆ192.168.25.102ï¼‰
  - Secondary2ï¼š`mssql-secondary2`ï¼ˆ192.168.25.103ï¼‰
- Listener è™›æ“¬ IPï¼š`192.168.25.250`
- å­ç¶²ï¼š`192.168.25.0/24`
- ç”¨æˆ¶ç«¯é€£ç·šï¼š`AGListener:1433`

---

## ğŸš€ éƒ¨ç½²æµç¨‹

---

### ğŸ§± ç¬¬ 1 æ­¥ï¼šéƒ¨ç½²å®¹å™¨ç’°å¢ƒ

#### âœ… å»ºç«‹å…±äº«ç›®éŒ„ï¼ˆä¸»æ©ŸåŸ·è¡Œï¼‰

```bash
sudo mkdir -p /mnt/hadr_certs
sudo chown -R 10001:0 /mnt/hadr_certs
```

#### âœ… å•Ÿå‹• SQL Server å®¹å™¨

```bash
docker compose up -d
```

---

### ğŸ” ç¬¬ 2 æ­¥ï¼šå»ºç«‹æ†‘è­‰èˆ‡ HADR Endpoint

#### âœ… åœ¨ Primary å®¹å™¨ä¸­åŸ·è¡Œ

```bash
docker exec -it mssql-primary bash
./setup-hadr.sh PRIMARY
```

æ­¤æ­¥é©Ÿå°‡ç”¢ç”Ÿæ†‘è­‰ `/var/opt/mssql/hadr_cert/hadr_primary_cert.cer`

#### âœ… æ‰‹å‹•å°‡æ†‘è­‰è¤‡è£½åˆ°å…¶ä»–å®¹å™¨

```bash
docker cp mssql-primary:/var/opt/mssql/hadr_cert/hadr_primary_cert.cer .
docker cp hadr_primary_cert.cer mssql-secondary1:/var/opt/mssql/hadr_cert/
docker cp hadr_primary_cert.cer mssql-secondary2:/var/opt/mssql/hadr_cert/
```

#### âœ… åœ¨æ¯å€‹ Secondary å®¹å™¨ä¸­åŸ·è¡Œ

```bash
docker exec -it mssql-secondary1 bash
./setup-hadr.sh SECONDARY

docker exec -it mssql-secondary2 bash
./setup-hadr.sh SECONDARY
```

---

### ğŸ“¡ ç¬¬ 3 æ­¥ï¼šå»ºç«‹ Availability Group èˆ‡ Listener

#### âœ… ç™»å…¥ Primary ä¸¦åŸ·è¡Œ AG è¨­å®šè…³æœ¬

```bash
docker exec -it mssql-primary /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'Sql@admin123' -i /var/opt/mssql/scripts/init_ag.sql
```

> æ­¤è…³æœ¬æœƒï¼š
> - å»ºç«‹ AGï¼ˆAG_DevGroupï¼‰
> - è¨­å®š 3 ç¯€é»è¤‡æœ¬ï¼ˆå«åŒæ­¥èˆ‡éåŒæ­¥ï¼‰
> - å»ºç«‹ Listenerï¼ˆ192.168.25.250ï¼‰
> - åŠ å…¥è³‡æ–™åº« `TestDB`ï¼ˆè«‹å…ˆå»ºç«‹ç©º DBï¼‰

---

### ğŸ§ª ç¬¬ 4 æ­¥ï¼šæ¸¬è©¦é€£ç·š

#### âœ… æ‰‹å‹•åœ¨ /etc/hosts è¨­å®š DNSï¼ˆè‹¥ç„¡å…§éƒ¨ DNSï¼‰

```bash
sudo echo "192.168.25.250 AGListener" >> /etc/hosts
```

#### âœ… æ¸¬è©¦é€£ç·š

```bash
sqlcmd -S AGListener,1433 -U SA -P 'Sql@admin123'
```

æˆ–æ‡‰ç”¨ç¨‹å¼é€£ç·šå­—ä¸²ï¼š

```plaintext
Server=AGListener;Database=TestDB;User Id=SA;Password=Sql@admin123;
```

---

## ğŸ§¼ æ¸…é™¤å®¹å™¨

```bash
docker compose down -v
```

---

### ğŸ“¦ æª”æ¡ˆç¸½è¦½

| æª”æ¡ˆåç¨±              | èªªæ˜                            |
|-----------------------|----------------------------------|
| `docker-compose.yml` | å»ºç«‹ä¸‰ç¯€é» SQL Server å®¹å™¨ç’°å¢ƒ |
| `setup-hadr.sh`       | å»ºç«‹æ†‘è­‰èˆ‡ HADR Endpoint         |
| `init_ag.sql`         | å»ºç«‹ Availability Group èˆ‡ Listener |

---

